# üöÄ Backend - Desafio T√©cnico WeFit

###

<br>

Este projeto √© uma API desenvolvida como parte do **Desafio T√©cnico Backend da WeFit**, implementando um sistema de autentica√ß√£o JWT e cria√ß√£o de perfis de usu√°rio com valida√ß√£o de endere√ßo brasileiro atrav√©s da API ViaCEP.

A aplica√ß√£o demonstra boas pr√°ticas de engenharia de software, arquitetura modular, valida√ß√µes robustas, tratamento de erros, testes unit√°rios com 100% de cobertura e documenta√ß√£o completa via Swagger/OpenAPI.

<br>

## üõ†Ô∏è Tecnologias

Este projeto utiliza as seguintes tecnologias:

- **Node.js** com framework **NestJS** e **TypeScript**;
- **Prisma ORM** para comunica√ß√£o e manipula√ß√£o do banco de dados **MySQL**;
- **Docker** e **Docker Compose** para containeriza√ß√£o do banco de dados;

- **Passport.js** para implementa√ß√£o de estrat√©gias de autentica√ß√£o;
- **JWT** para autentica√ß√£o e autoriza√ß√£o de acesso;
- **Bcrypt** para criptografia de senhas;

- **Axios** para integra√ß√£o com APIs externas (ViaCEP);
- **Class Validator** e **Class Transformer** para valida√ß√£o de DTOs;
- **Jest** para execu√ß√£o e automa√ß√£o dos testes unit√°rios;
- **Swagger/OpenAPI** para documenta√ß√£o interativa da API;

<br>

## ‚öôÔ∏è Funcionalidades

### Autentica√ß√£o:
- Login com email e senha gerando token JWT;
- Endpoint protegido para obter informa√ß√µes do usu√°rio autenticado;
- Sistema de guards (JWT e Local) para prote√ß√£o de rotas;
- Decorador `@IsPublic()` para rotas p√∫blicas;

### Gerenciamento de Perfis:
- Cria√ß√£o de perfil de usu√°rio com dados pessoais e endere√ßo;
- Valida√ß√£o de **CPF** e **CNPJ** com algoritmo de d√≠gitos verificadores;
- Valida√ß√£o de formato de telefone celular e fixo brasileiro;
- Integra√ß√£o com **API ViaCEP** para valida√ß√£o autom√°tica de endere√ßo;
- Verifica√ß√£o de correspond√™ncia entre CEP informado e cidade/estado;

### Valida√ß√µes e Tratamento de Erros:
- Valida√ß√£o de unicidade de email, CPF, CNPJ e celular;
- Tratamento personalizado de erros do Prisma (unique constraints);
- Mensagens de erro descritivas e c√≥digos HTTP apropriados;
- Sistema centralizado de erros com `AppError`;

<br>

## üìã Observa√ß√£o sobre Implementa√ß√£o

Este projeto foi implementado com **NestJS + TypeScript** (arquitetura modular, DTOs, pipes, guards e Dependency Injection) visando boas pr√°ticas de engenharia de software e facilitar evolu√ß√£o, manuten√ß√£o e testes:

- ‚úÖ **Arquitetura escal√°vel** com m√≥dulos bem definidos;
- ‚úÖ **Inje√ß√£o de depend√™ncias** nativa;
- ‚úÖ **Valida√ß√£o autom√°tica** via pipes e decorators;
- ‚úÖ **Documenta√ß√£o autom√°tica** com Swagger/OpenAPI integrado;
- ‚úÖ **Testabilidade** facilitada com mocks e DI;
- ‚úÖ **TypeScript** para type safety e melhor DX;

Para iniciar o projeto, siga o guia de configura√ß√£o abaixo. O comando `npm start` inicia a aplica√ß√£o NestJS normalmente.

<br>

## üîß Configura√ß√£o do Projeto

### Requisitos

- **Node.js** (vers√£o 18.x ou superior);
- **Docker** e **Docker Compose**;
- **npm** ou **yarn**;

<br>

### Instala√ß√£o

1. **Clone o reposit√≥rio:**

```bash
$ git clone git@github.com:rafittu/back-wefit.git
$ cd back-wefit
```

2. **Instale as depend√™ncias:**

```bash
$ npm install
```

3. **Configure as vari√°veis de ambiente:**

Crie um arquivo `.env` na raiz do projeto e preencha as informa√ß√µes de acordo com o arquivo `.env.example` dispon√≠vel:

```env
# APP PORT
PORT=3008

# CORS
CORS_ORIGINS=http://localhost:3000

# DATABASE
MYSQLDB_PASSWORD=password
MYSQLDB_PORT=3306
MYSQLDB_DATABASE=wefit

DATABASE_URL='mysql://user:password@localhost:3306/wefit'

# JWT
JWT_SECRET='WeFit#SuperSecret'
JWT_EXPIRATION_TIME='27d'
```

4. **Inicie o banco de dados:**

```bash
$ docker-compose up -d
```

O Docker Compose criar√° um container MySQL acess√≠vel em `localhost:3306` com usu√°rio `root` e senha `senha_root_123`.

5. **Execute as migrations do Prisma:**

```bash
$ npx prisma migrate dev
```

6. **Inicie a aplica√ß√£o:**

```bash
# Modo desenvolvimento
$ npm start

# Modo watch (recarrega automaticamente)
$ npm run start:dev

# Modo produ√ß√£o
$ npm run start:prod
```

A API estar√° dispon√≠vel em `http://localhost:3008` (ou porta configurada no `.env`).

<br>

## üì° Endpoints Principais

### Autentica√ß√£o (P√∫blica):

- **`POST /login`:** Autenticar usu√°rio e receber token JWT;
  
  **Corpo da requisi√ß√£o:**
  ```json
  {
    "email": "user1@example.com",
    "password": "Password123!"
  }
  ```
  
  **Resposta:**
  ```json
  {
    "error": {
      "status": false,
      "message": null,
      "code": null
    },
    "data": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
  }
  ```

  > **Nota:** O `accessToken` retornado deve ser utilizado no campo `Authorization` no formato `Bearer {accessToken}` no cabe√ßalho das requisi√ß√µes protegidas.

<br>

### Autentica√ß√£o (Protegida):

- **`GET /me`:** Obter informa√ß√µes do usu√°rio autenticado;
  
  **Headers:**
  ```
  Authorization: Bearer {accessToken}
  ```
  
  **Resposta:**
  ```json
  {
    "error": {
      "status": false,
      "message": null,
      "code": null
    },
    "data": {
      "id": "1",
      "name": "User One",
      "email": "user1@example.com"
    }
  }
  ```

<br>

### Perfil de Usu√°rio (Protegida):

- **`POST /profile/create`:** Criar um novo perfil de usu√°rio;
  
  **Headers:**
  ```
  Authorization: Bearer {accessToken}
  ```
  
  **Corpo da requisi√ß√£o:**
  ```json
  {
    "cpf": "52998224725",
    "name": "Jo√£o Silva",
    "cellphone": "11999887766",
    "phone": "1133334444",
    "email": "joao.silva@example.com",
    "emailConfirmation": "joao.silva@example.com",
    "zipCode": "01001000",
    "street": "Pra√ßa da S√©",
    "number": "100",
    "complement": "Lado √≠mpar",
    "city": "S√£o Paulo",
    "neighborhood": "S√©",
    "state": "SP"
  }
  ```
  
  **Resposta (201 - Created):**
  ```json
  {
    "error": {
      "status": false,
      "message": null,
      "code": null
    },
    "data": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "cpf": "52998224725",
      "cnpj": null,
      "name": "Jo√£o Silva",
      "cellphone": "11999887766",
      "phone": "1133334444",
      "email": "joao.silva@example.com",
      "createdAt": "2025-10-17T14:30:00.000Z",
      "updatedAt": "2025-10-17T14:30:00.000Z",
      "address": {
        "id": "660e8400-e29b-41d4-a716-446655440001",
        "profileId": "550e8400-e29b-41d4-a716-446655440000",
        "zipcode": "01001000",
        "street": "Pra√ßa da S√©",
        "number": "100",
        "complement": "Lado √≠mpar",
        "neighborhood": "S√©",
        "city": "S√£o Paulo",
        "state": "SP",
        "createdAt": "2025-10-17T14:30:00.000Z",
        "updatedAt": "2025-10-17T14:30:00.000Z"
      }
    }
  }
  ```

<br>

### Respostas de Erro

Todos os endpoints retornam erros no seguinte formato:

```json
{
  "internalCode": "profile-service.createProfile",
  "code": 400,
  "message": "provided CPF is invalid."
}
```

**C√≥digos HTTP:**
- `400` - Valida√ß√£o falhou (documento inv√°lido, campos obrigat√≥rios, etc.)
- `401` - N√£o autenticado ou token inv√°lido
- `409` - Conflito (email, CPF, CNPJ ou celular j√° cadastrado)
- `500` - Erro interno do servidor

<br>

## üß™ Testes

A API possui uma cobertura de testes unit√°rios abrangente, com **100% de cobertura** em cada parte essencial do c√≥digo, garantindo a qualidade e o correto funcionamento do sistema.

### Executar todos os testes:

```bash
$ npm run test
```

### Gerar relat√≥rio de cobertura:

```bash
$ npm run test:cov
```

### Resultado esperado:

```
Test Suites: 3 passed, 3 total
Tests:       34 passed, 34 total
Snapshots:   0 total

--------------------|---------|----------|---------|---------|
File                | % Stmts | % Branch | % Funcs | % Lines |
--------------------|---------|----------|---------|---------|
profile.controller  |   100   |   100    |   100   |   100   |
profile.service     |   100   |  81.57   |   100   |   100   |
profile.repository  |   100   |   100    |   100   |   100   |
--------------------|---------|----------|---------|---------|
```

<br>

## üìö Documenta√ß√£o

A documenta√ß√£o completa da API est√° dispon√≠vel atrav√©s do **Swagger UI**. Para acess√°-la:

1. Certifique-se de ter a API em execu√ß√£o;
2. Abra um navegador e acesse: `http://localhost:3008/v1/api-doc` (substitua `3008` pela porta configurada no `.env`);
3. A documenta√ß√£o interativa ser√° exibida, permitindo:
   - Explorar todos os endpoints dispon√≠veis;
   - Visualizar schemas de request/response;
   - Testar endpoints diretamente pelo navegador;
   - Autenticar usando o bot√£o "Authorize" com o token JWT;

### Como testar no Swagger:

1. Execute `POST /login` com as credenciais de teste (ex: `user1@example.com / Password123!`);
2. Copie o `accessToken` retornado;
3. Clique no bot√£o "Authorize" (cadeado verde) no topo da p√°gina;
4. Cole o token e clique em "Authorize";
5. Agora voc√™ pode testar os endpoints protegidos (`GET /me` e `POST /profile/create`);

<br>

## üóÇÔ∏è Estrutura do Projeto

```
back-auth/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/          # Hist√≥rico de migrations do Prisma
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma        # Schema do banco de dados
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ common/              # Recursos compartilhados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators/      # Decorators customizados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errors/          # Sistema de erros customizado
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filter/          # Exception filters
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ interceptors/    # Response interceptor
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/            # M√≥dulo de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/      # JWT e Local guards
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies/  # Passport strategies
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/    # L√≥gica de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile/         # M√≥dulo de perfil
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dto/         # Data Transfer Objects
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ interfaces/  # Interfaces TypeScript
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ repository/  # Camada de dados
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ services/    # L√≥gica de neg√≥cio
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ test/        # Testes unit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ utils/               # Validadores (CPF, CNPJ)
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts        # M√≥dulo raiz
‚îÇ   ‚îú‚îÄ‚îÄ main.ts              # Entry point
‚îÇ   ‚îî‚îÄ‚îÄ prisma.service.ts    # Servi√ßo Prisma
‚îú‚îÄ‚îÄ swagger.json             # Documenta√ß√£o OpenAPI 3.0
‚îú‚îÄ‚îÄ docker-compose.yml       # Configura√ß√£o Docker
‚îî‚îÄ‚îÄ README.md
```

<br>

## üîê Usu√°rios de Teste (Mock)

A autentica√ß√£o atualmente utiliza usu√°rios mock definidos em `src/modules/auth/mocks/auth.mock.ts`:

| Email | Senha | Nome |
|-------|-------|------|
| user1@example.com | Password123! | User One |
| user2@example.com | Secret456$ | User Two |
| user3@example.com | HelloWorld789# | User Three |

> **Nota:** A integra√ß√£o com banco de dados para autentica√ß√£o pode ser implementada em vers√µes futuras.

<br>

## üöÄ Decis√µes T√©cnicas

### Por que NestJS?

- **Arquitetura modular e escal√°vel** similar a frameworks enterprise (Spring Boot);
- **Dependency Injection** nativa facilita testes e manuten√ß√£o;
- **Decorators** para valida√ß√£o autom√°tica e redu√ß√£o de boilerplate;
- **TypeScript first** com type safety end-to-end;
- **Ecossistema maduro** com guards, pipes, interceptors, filters;
- **Documenta√ß√£o autom√°tica** com Swagger/OpenAPI integrado;
- **Alinhamento com requisitos da vaga:** boas pr√°ticas, c√≥digo limpo, test√°vel e escal√°vel;

### Estrutura em Camadas:

- **Controller:** Recebe requisi√ß√µes HTTP, delega para services
- **Service:** L√≥gica de neg√≥cio e orquestra√ß√£o
- **Repository:** Acesso a dados (Prisma)
- **DTOs:** Valida√ß√£o de entrada com class-validator
- **Interfaces:** Contratos TypeScript para type safety

### Tratamento de Erros:

- **AppError customizado** com c√≥digo interno para debugging
- **HttpExceptionFilter** para padroniza√ß√£o de respostas de erro
- **Prisma error handling** para erros de banco de dados

<br>

##

<p align="right">
  <a href="https://www.linkedin.com/in/rafittu/">Rafael Ribeiro üöÄ</a>
</p>
